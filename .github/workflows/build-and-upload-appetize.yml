name: Build iOS app and upload to Appetize

on:
  push:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine build method
        id: detect
        run: |
          # try to find an .xcodeproj or .xcworkspace in the repo
          XCODEPROJ=$(find . -maxdepth 3 -name "*.xcodeproj" | head -n 1 || true)
          XCWORKSPACE=$(find . -maxdepth 3 -name "*.xcworkspace" | head -n 1 || true)
          if [ -n "$XCWORKSPACE" ]; then
            echo "build_type=workspace" >> $GITHUB_OUTPUT
            echo "path=$XCWORKSPACE" >> $GITHUB_OUTPUT
          elif [ -n "$XCODEPROJ" ]; then
            echo "build_type=project" >> $GITHUB_OUTPUT
            echo "path=$XCODEPROJ" >> $GITHUB_OUTPUT
          else
            echo "build_type=none" >> $GITHUB_OUTPUT
          fi

      - name: Build .app for Simulator
        if: steps.detect.outputs.build_type != 'none'
        run: |
          set -e
          DERIVED_DATA=build
          # Default names - replace these if your project uses different names
          PROJECT_PATH="${{ steps.detect.outputs.path }}"
          # You may override these via workflow inputs or by editing this file
          SCHEME="WeatherApp-iOS"
          CONFIGURATION="Debug"

          if [[ "$PROJECT_PATH" == *.xcworkspace ]]; then
            xcodebuild -workspace "$PROJECT_PATH" -scheme "$SCHEME" -sdk iphonesimulator -configuration "$CONFIGURATION" -derivedDataPath "$DERIVED_DATA" clean build
          else
            xcodebuild -project "$PROJECT_PATH" -scheme "$SCHEME" -sdk iphonesimulator -configuration "$CONFIGURATION" -derivedDataPath "$DERIVED_DATA" clean build
          fi

      - name: Fail if no Xcode project found
        if: steps.detect.outputs.build_type == 'none'
        run: |
          echo "No .xcodeproj or .xcworkspace found in the repository. Add your Xcode project or adjust this workflow." >&2
          exit 1

      - name: Zip .app
        run: |
          set -e
          APP_PATH=$(find build/Build/Products -name "*.app" | head -n 1 || true)
          if [ -z "$APP_PATH" ]; then
            echo "Could not find .app; check project/scheme names" >&2
            ls -R build || true
            exit 1
          fi
          zip -r app.zip "$APP_PATH"

      - name: Upload to Appetize
        env:
          APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
        run: |
          set -e
          if [ -z "$APPETIZE_API_TOKEN" ]; then
            echo "Missing secret APPETIZE_API_TOKEN. Add it to repository secrets." >&2
            exit 1
          fi
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $APPETIZE_API_TOKEN" \
            -F "file=@app.zip" \
            "https://api.appetize.io/v1/apps")
          echo "Appetize response: $RESPONSE"
          echo "$RESPONSE" > appetize_response.json
          # print embed URL if present
          python3 - <<'PY'
          import json,sys
          try:
            data=json.load(open('appetize_response.json'))
            print(data.get('data',{}).get('embedUrl',''))
          except Exception as e:
            print('could not parse response', e)
          PY

      - name: Upload app.zip as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-zip
          path: app.zip

      - name: Upload Appetize response
        uses: actions/upload-artifact@v4
        with:
          name: appetize-response
          path: appetize_response.json

# Notes:
# - Set repository secret `APPETIZE_API_TOKEN` to your Appetize API token.
# - Edit the `SCHEME` variable above to match your Xcode scheme name.
# - If your project requires CocoaPods or other setup, add steps to install those before building.