name: Build iOS app and upload to Appetize

on:
  push:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby (for CocoaPods, אם צריך)
        uses: ruby/setup-ruby@v1

      - name: Install CocoaPods dependencies
        run: |
          if [ -f Podfile ]; then
            sudo gem install cocoapods
            pod install
          fi

      - name: Find Xcode project/workspace
        id: detect
        run: |
          XCODEPROJ=$(find . -maxdepth 3 -name "*.xcodeproj" | head -n 1 || true)
          XCWORKSPACE=$(find . -maxdepth 3 -name "*.xcworkspace" | head -n 1 || true)
          if [ -n "$XCWORKSPACE" ]; then
            echo "build_type=workspace" >> $GITHUB_OUTPUT
            echo "path=$XCWORKSPACE" >> $GITHUB_OUTPUT
          elif [ -n "$XCODEPROJ" ]; then
            echo "build_type=project" >> $GITHUB_OUTPUT
            echo "path=$XCODEPROJ" >> $GITHUB_OUTPUT
          else
            echo "build_type=none" >> $GITHUB_OUTPUT
          fi

      - name: Build .app for Simulator
        if: steps.detect.outputs.build_type != 'none'
        run: |
          set -e
          DERIVED_DATA=build
          PROJECT_PATH="${{ steps.detect.outputs.path }}"
          SCHEME="WeatherApp-iOS"  # שם ה-Scheme שלך
          CONFIGURATION="Debug"

          if [[ "$PROJECT_PATH" == *.xcworkspace ]]; then
            xcodebuild -workspace "$PROJECT_PATH" -scheme "$SCHEME" -sdk iphonesimulator -configuration "$CONFIGURATION" -derivedDataPath "$DERIVED_DATA" clean build
          else
            xcodebuild -project "$PROJECT_PATH" -scheme "$SCHEME" -sdk iphonesimulator -configuration "$CONFIGURATION" -derivedDataPath "$DERIVED_DATA" clean build
          fi

      - name: Zip .app
        run: |
          set -e
          APP_PATH=$(find build/Build/Products -name "*.app" | head -n 1 || true)
          if [ -z "$APP_PATH" ]; then
            echo "Could not find .app; check project/scheme names" >&2
            exit 1
          fi
          zip -r app.zip "$APP_PATH"

      - name: Upload to Appetize
        env:
          APPETIZE_API_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
        run: |
          set -e
          if [ -z "$APPETIZE_API_TOKEN" ]; then
            echo "Missing secret APPETIZE_API_TOKEN." >&2
            exit 1
          fi
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $APPETIZE_API_TOKEN" \
            -F "file=@app.zip" \
            "https://api.appetize.io/v1/apps")
          echo "$RESPONSE" > appetize_response.json
          # הצג את ה-embedUrl
          python3 -c "import json; data=json.load(open('appetize_response.json')); print('Embed URL:', data.get('data', {}).get('embedUrl', ''))"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-zip
          path: app.zip
